##' Read in equivalence class
##'
##' Read in equivalence class file generated from \code{kallisto} (version 0.44.0). The \code{*.ec} file can be generated by the \code{pseudo} command in the \code{kallisto}.
##'
##' @title Standard read in ec files
##' @param ecpath The path of ec files.
##' @return A \code{list} each element is combined transcript IDs
##' @examples
##' require('magrittr')
##'
##' ec <- system.file('extdata', 'example.ec', package = 'RNASeqEM') %>% read_ec
##' @author Yulong Niu \email{yulong.niu@@hotmail.com}
##' @importFrom utils read.table
##' @importFrom magrittr %>%
##' @export
##'
read_ec <- function(ecpath) {

  ecMat <- ecpath %>%
    read.table(stringsAsFactors = FALSE)

  ecList <- apply(ecMat, 1, function(x) {
    eachec <- list(ec = x[1] %>% as.integer,
                   t = x[2] %>%
                     strsplit(split = ',', fixed = TRUE) %>%
                     unlist(use.names = FALSE) %>%
                     as.integer)
    })

  return(ecList)
}

##' Find equivalence class clusters
##'
##' Cluster ec with common transcripts.
##'
##' @title Cluster equivalence class
##' @param ec A \code{list} of equivalence class
##' @return A \code{list}. Each element is an ec cluster.
##' @examples
##' require('magrittr')
##'
##' ec <- system.file('extdata', 'example.ec', package = 'RNASeqEM') %>% read_ec
##' Clusterec(ec)
##' @author Yulong Niu \email{yulong.niu@@hotmail.com}
##' @importFrom magrittr %<>% %>%
##' @export
##'
Clusterec <- function(ec) {

  eccluster <- list()

  ## search seed
  ec1st <- ec[[1]]$ec
  t1st <- ec[[1]]$t

  ## search space
  ecleft <- ec[-1]
  ecs <- lapply(ecleft, `[[`, 1)
  ts <- lapply(ecleft, `[[`, 2)

  while(TRUE) {

    ## break point
    if (length(ecs) == 0) {
      break
    } else {}

    ## check common t
    eachlog <- sapply(ts, function(x) {
      return(sum(t1st %in% x) > 0)
    })

    ## update ecs and ts
    if (sum(eachlog) > 0) {
      ec1st <- ecs %>% collapseL_(eachlog) %>% c(ec1st)
      t1st <- ts %>% collapseL_(eachlog) %>% c(t1st) %>% unique
      ecs %<>% `[`(!eachlog)
      ts %<>% `[`(!eachlog)
    } else {
      eccluster[[length(eccluster) + 1]] <- list(ec = ec1st, t = t1st)
      ec1st <- ecs[[1]]
      t1st <- ts[[1]]
      ecs %<>% `[`(-1)
      ts %<>% `[`(-1)
    }
  }

  return(eccluster)
}


##' Cluster EM internal functions.
##'
##' Collapse list.
##'
##' @title Internal functions for cluster EM
##' @param l A \code{list}. Each element is a vector.
##' @return A \code{list}.
##' @author Yulong Niu \email{yulong.niu@@hotmail.com}
##' @importFrom magrittr %>%
##' @keywords internal
##'
collapseL_ <- function(l, logidx) {
  res <- l[logidx] %>% unlist
  return(res)
}
